<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apprentissage du russe</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ‡·ðŸ‡º</text></svg>">
<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 20px;
    background: #212121;
    color: #eee;
}
h1 { color: #fff; font-weight: 700; margin-bottom: 20px; }
#score { font-size: clamp(1.5rem, 4vw, 2.5rem); margin-bottom: 20px; color: #fff; }
#letter {
    background-color: #171717;
    color: #fff;
    display: block;
    padding: 1rem 2rem;
    border-radius: 1rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    min-width: 120px;
    max-width: calc(100% - 40px);
    box-sizing: border-box;
    text-align: center;
    white-space: nowrap;
    font-size: 96px;
}
.separator {
    all: unset;
    display: block;
    height: 2px;
    background-color: #4db8ff;
    max-width: calc(100% - 40px);
    min-width: 120px;
    border-radius: 1rem;
    box-sizing: border-box;
}
input {
    all: unset;
    background-color: #171717;
    color: #fff;
    display: block;
    padding: 1rem 2rem;
    border-radius: 1rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    min-width: 120px;
    max-width: calc(100% - 40px);
    box-sizing: border-box;
    text-align: center;
    white-space: nowrap;
    font-size: 96px;
    width: 100%;
}
input::placeholder { color: #555; }
button {
    font-size: clamp(0.8rem, 3vw, 1.2rem);
    padding: 0.8rem 2rem;
    margin: 10px 5px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    background: #333;
    color: #fff;
    border-color: #555;
}
button:hover { background-color: #2980b9; transform: translateY(-2px); }
#result { margin-top: 20px; font-size: clamp(1rem, 3vw, 1.5rem); font-weight: 500; }
#info { font-size: clamp(0.9rem, 2.5vw, 1.2rem); margin-top: 10px; color: #555; }
#bingContainer {
    margin-top: 20px;
}
iframe {
    border: 1px solid #555;
    width: 100%;
    max-width: 600px;
    height: 300px;
}
</style>
</head>
<body>
<h1>Apprentissage du russe</h1>
<div id="score">Note moyenne : 0 / 20</div>
<div id="letter"></div>
<hr class="separator">
<input type="text" id="answer" placeholder="TranslittÃ©ration ou traduction">
<div>
    <button id="listenButton">ðŸ”Š</button>
</div>
<div>
    <button id="actionButton">Valider</button>
</div>
<div id="result"></div>
<div id="info"></div>
<div id="bingContainer"></div>

<script>
let russianLearning = [];
let currentItem = null;
let scores = [];
let answered = false;

const actionButton = document.getElementById('actionButton');
const listenButton = document.getElementById('listenButton');

function nextQuestion() {
    answered = false;
    actionButton.textContent = "Valider";

    const index = Math.floor(Math.random() * russianLearning.length);
    currentItem = russianLearning[index];

    const letterDiv = document.getElementById('letter');
    letterDiv.textContent = currentItem.cyr || '';

    // âœ… Si le champ "answer" a Ã©tÃ© remplacÃ© par un <div>, on le recrÃ©e proprement
    const oldAnswer = document.getElementById('answer');
    if (oldAnswer.tagName.toLowerCase() !== 'input') {
        const newInput = document.createElement('input');
    newInput.type = "text";
    newInput.id = "answer";
    newInput.placeholder = "TranslittÃ©ration ou traduction";
    newInput.style.all = "unset";
    newInput.style.backgroundColor = "#171717";
    newInput.style.color = "#fff";
    newInput.style.display = "block";
    newInput.style.padding = "1rem 2rem";
    newInput.style.borderRadius = "1rem";
    newInput.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
    newInput.style.minWidth = "120px";
    newInput.style.maxWidth = "calc(100% - 40px)";
    newInput.style.boxSizing = "border-box";
    newInput.style.textAlign = "center";
    newInput.style.whiteSpace = "nowrap";
    newInput.style.fontSize = "96px";
    newInput.style.width = "100%";
        oldAnswer.replaceWith(newInput);

        // RÃ©attacher l'Ã©vÃ©nement "Enter"
    newInput.addEventListener('keydown', function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                actionButton.click();
            }
        });
    }

    document.getElementById('answer').value = '';
    document.getElementById('result').textContent = '';
    document.getElementById('info').textContent = '';
    document.getElementById('answer').focus();
    adjustFontSize();
    document.getElementById('bingContainer').innerHTML = '';
}

function checkAnswer() {
    const inputEl = document.getElementById('answer');
    const userAnswer = inputEl.value.trim().toLowerCase();
    if (!currentItem) return;

    const correctAnswers = currentItem.trans.map(a => a.toLowerCase());
    const correct = correctAnswers[0];
    let score = 0;
    let displayHTML = "";

    // ðŸ”¹ Fonction utilitaire : "diff" basique pour colorer intelligemment
    function diffStrings(user, target) {
        let result = "";
        let i = 0, j = 0;
        let matches = 0;

        while (i < user.length || j < target.length) {
            const u = user[i];
            const t = target[j];

            if (u === t) {
                result += `<span style="color:limegreen">${t}</span>`;
                i++; j++; matches++;
            } 
            else if (u === undefined) { 
                // l'utilisateur a fini plus tÃ´t â†’ manque des lettres
                result += `<span style="color:red">${t}</span>`;
                j++;
            }
            else if (t === undefined) { 
                // l'utilisateur a Ã©crit trop
                i++;
            }
            else if (user[i+1] === t) {
                // utilisateur a insÃ©rÃ© un caractÃ¨re en trop
                i++;
            }
            else if (user[i] === target[j+1]) {
                // utilisateur a oubliÃ© un caractÃ¨re
                result += `<span style="color:red">${t}</span>`;
                j++;
            }
            else {
                // caractÃ¨re diffÃ©rent
                result += `<span style="color:red">${t}</span>`;
                i++; j++;
            }
        }
        const similarity = matches / target.length;
        return { html: result, score: Math.round(similarity * 20) };
    }

    let diff = diffStrings(userAnswer, correct);
    score = diff.score;
    displayHTML = diff.html;

    // âœ… Si tout juste
    if (score === 20) {
        document.getElementById('result').style.color = 'green';
    } else {
        document.getElementById('result').style.color = 'red';
    }

    // Score et moyenne
    scores.push(score);
    const sum = scores.reduce((a, b) => a + b, 0);
    const average = (sum / scores.length).toFixed(1);
    document.getElementById('score').textContent = `Note moyenne : ${average} / 20`;

    // Texte rÃ©sultat
    document.getElementById('result').textContent = score === 20 ?
        `âœ… Correct : "${correctAnswers.join('" ou "')}"` :
        `âŒ Faux : "${correctAnswers.join('" ou "')}"`;

    // Genre
    if (currentItem.genre) {
        document.getElementById('info').textContent = `Genre : ${
            currentItem.genre === 'm' ? 'masculin' :
            currentItem.genre === 'f' ? 'fÃ©minin' :
            'neutre'
        }`;
    } else {
        document.getElementById('info').textContent = '';
    }

    // Affichage dans le champ
    const wrapper = document.createElement('div');
    wrapper.innerHTML = displayHTML;
    inputEl.replaceWith(wrapper);
    wrapper.id = "answer";
    wrapper.style.all = "unset";
    wrapper.style.backgroundColor = "#171717";
    wrapper.style.color = "#fff";
    wrapper.style.display = "block";
    wrapper.style.padding = "1rem 2rem";
    wrapper.style.borderRadius = "1rem";
    wrapper.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
    wrapper.style.minWidth = "120px";
    wrapper.style.maxWidth = "calc(100% - 40px)";
    wrapper.style.boxSizing = "border-box";
    wrapper.style.textAlign = "center";
    wrapper.style.whiteSpace = "nowrap";
    wrapper.style.fontSize = "96px";
    wrapper.style.width = "100%";
}

function adjustFontSize() {
    const letterDiv = document.getElementById('letter');
    let fontSize = 96;
    letterDiv.style.fontSize = fontSize + 'px';
    while (letterDiv.scrollWidth > letterDiv.clientWidth && fontSize > 10) {
        fontSize -= 1;
        letterDiv.style.fontSize = fontSize + 'px';
    }
}

actionButton.addEventListener('click', function () {
    if (!answered) {
        checkAnswer();
        answered = true;
        actionButton.textContent = "Prochaine question";
    } else {
        nextQuestion();
    }
});

document.getElementById('answer').addEventListener('keydown', function (event) {
    if (event.key === "Enter") {
        event.preventDefault();
        actionButton.click();
    }
});

listenButton.addEventListener('click', () => {
    if (!currentItem || !currentItem.cyr) return;
    
    const word = encodeURIComponent(currentItem.cyr);
    const bingUrl = `https://www.bing.com/translator?from=ru&to=fr&text=${word}`;
    
    const container = document.getElementById('bingContainer');
    container.innerHTML = '';
    
    const iframe = document.createElement('iframe');
    iframe.src = bingUrl;
    container.appendChild(iframe);
});

fetch('list.json')
    .then(response => response.json())
    .then(data => {
        russianLearning = data;
        nextQuestion();
    })
    .catch(err => console.error('Erreur chargement JSON :', err));
</script>
</body>
</html>
